{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "fe3ccfb2",
   "metadata": {},
   "source": [
    "# 06 ‚Äî Pr√©-processamento e Modelagem (JupyterLab)\n",
    "\n",
    "Este notebook d√° sequ√™ncia ao projeto, preparando *features* e treinando modelos de ML.\n",
    "Ele foi pensado para rodar **localmente** no JupyterLab, com caminhos relativos ao reposit√≥rio.\n",
    "\n",
    "> **Dica:** mantenha os dados consolidados em `data/gold/` conforme a estrutura do projeto.\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "911a55d1",
   "metadata": {},
   "source": [
    "## 0. Configura√ß√µes iniciais\n",
    "\n",
    "- Paths\n",
    "- Depend√™ncias\n",
    "- Par√¢metros edit√°veis (targets, colunas categ√≥ricas/num√©ricas)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "9b77ac8b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Project root: /home/rusch/√Årea de trabalho/Projeto_Whirpool/Data_Science_Projects/eda\n",
      "Gold path: /home/rusch/√Årea de trabalho/Projeto_Whirpool/Data_Science_Projects/eda/data/gold\n",
      "Python version: 3.12.7\n"
     ]
    }
   ],
   "source": [
    "# Imports e checagens de ambiente\n",
    "import os\n",
    "import sys\n",
    "import joblib\n",
    "import warnings\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "\n",
    "warnings.filterwarnings('ignore')\n",
    "\n",
    "from pathlib import Path\n",
    "from datetime import datetime\n",
    "from sklearn.compose import ColumnTransformer\n",
    "from sklearn.impute import SimpleImputer\n",
    "from sklearn.preprocessing import OneHotEncoder, RobustScaler, StandardScaler\n",
    "from sklearn.pipeline import Pipeline\n",
    "from sklearn.model_selection import cross_val_score, GridSearchCV, TimeSeriesSplit \n",
    "from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score\n",
    "\n",
    "from sklearn.linear_model import LinearRegression, Ridge, Lasso\n",
    "from sklearn.ensemble import RandomForestRegressor\n",
    "\n",
    "from sklearn.cluster import KMeans\n",
    "from sklearn.decomposition import PCA\n",
    "from sklearn.inspection import permutation_importance\n",
    "\n",
    "\n",
    "# SHAP √© opcional; se n√£o estiver dispon√≠vel, usamos permutation importance\n",
    "try:\n",
    "    import shap\n",
    "    _HAS_SHAP = True\n",
    "except Exception:\n",
    "    _HAS_SHAP = False\n",
    "\n",
    "PROJECT_ROOT = Path('/home/rusch/√Årea de trabalho/Projeto_Whirpool/Data_Science_Projects/eda').resolve()\n",
    "DATA_GOLD = PROJECT_ROOT / 'data' / 'gold'\n",
    "MODEL_INPUT = PROJECT_ROOT / 'data' / 'model_input'\n",
    "MODELS_DIR = PROJECT_ROOT / 'models'\n",
    "REPORTS_DIR = PROJECT_ROOT / 'reports'\n",
    "\n",
    "for p in [MODEL_INPUT, MODELS_DIR, REPORTS_DIR]:\n",
    "    p.mkdir(parents=True, exist_ok=True)\n",
    "\n",
    "print('Project root:', PROJECT_ROOT)\n",
    "print('Gold path:', DATA_GOLD)\n",
    "print('Python version:', sys.version.split()[0])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c19fbba0",
   "metadata": {},
   "source": [
    "## 1. Carregamento de dados\n",
    "\n",
    "Carrega o arquivo consolidado de `data/gold/`.  \n",
    "> Ajuste o nome do arquivo caso necess√°rio.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "4dd590a9",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Carregando: /home/rusch/√Årea de trabalho/Projeto_Whirpool/Data_Science_Projects/eda/data/gold/kpi_consolidated_outliers_treated.parquet\n",
      "shape: (603, 29)\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date_key</th>\n",
       "      <th>y</th>\n",
       "      <th>m</th>\n",
       "      <th>site_code</th>\n",
       "      <th>cost_per_unit_imp</th>\n",
       "      <th>kwh_per_unit_imp</th>\n",
       "      <th>fx_effect_ratio_imp</th>\n",
       "      <th>cost_per_unit_imp_lag1</th>\n",
       "      <th>cost_per_unit_imp_roll3</th>\n",
       "      <th>kwh_per_unit_imp_lag1</th>\n",
       "      <th>...</th>\n",
       "      <th>kwh_per_unit_imp_z</th>\n",
       "      <th>kwh_per_unit_imp_is_outlier</th>\n",
       "      <th>fx_effect_ratio_imp_mean</th>\n",
       "      <th>fx_effect_ratio_imp_std</th>\n",
       "      <th>fx_effect_ratio_imp_z</th>\n",
       "      <th>fx_effect_ratio_imp_is_outlier</th>\n",
       "      <th>fx_effect_ratio_imp_cap</th>\n",
       "      <th>cost_per_unit_imp_robust</th>\n",
       "      <th>kwh_per_unit_imp_robust</th>\n",
       "      <th>fx_effect_ratio_imp_robust</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>20240101</td>\n",
       "      <td>2024</td>\n",
       "      <td>1</td>\n",
       "      <td>SC01</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>-3.708762e-08</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>False</td>\n",
       "      <td>2.718013e-06</td>\n",
       "      <td>3.896301e-06</td>\n",
       "      <td>-0.707107</td>\n",
       "      <td>False</td>\n",
       "      <td>-3.708762e-08</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>-0.591246</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>20240201</td>\n",
       "      <td>2024</td>\n",
       "      <td>2</td>\n",
       "      <td>SC01</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>1.029906e-07</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>False</td>\n",
       "      <td>-1.263414e-06</td>\n",
       "      <td>1.932388e-06</td>\n",
       "      <td>0.707107</td>\n",
       "      <td>False</td>\n",
       "      <td>1.029906e-07</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>-0.545836</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>20240301</td>\n",
       "      <td>2024</td>\n",
       "      <td>3</td>\n",
       "      <td>SC01</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>-5.269614e-06</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>False</td>\n",
       "      <td>-4.214648e-06</td>\n",
       "      <td>1.491947e-06</td>\n",
       "      <td>-0.707107</td>\n",
       "      <td>False</td>\n",
       "      <td>-5.269614e-06</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>-2.287501</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>20240401</td>\n",
       "      <td>2024</td>\n",
       "      <td>4</td>\n",
       "      <td>SC01</td>\n",
       "      <td>800.112631</td>\n",
       "      <td>0.521236</td>\n",
       "      <td>8.005353e-06</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>785.319145</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>...</td>\n",
       "      <td>0.162570</td>\n",
       "      <td>False</td>\n",
       "      <td>7.040908e-06</td>\n",
       "      <td>2.490187e-07</td>\n",
       "      <td>3.872983</td>\n",
       "      <td>True</td>\n",
       "      <td>7.040908e-06</td>\n",
       "      <td>0.260542</td>\n",
       "      <td>-0.147398</td>\n",
       "      <td>2.015913</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>20240501</td>\n",
       "      <td>2024</td>\n",
       "      <td>5</td>\n",
       "      <td>SC01</td>\n",
       "      <td>697.219664</td>\n",
       "      <td>0.525543</td>\n",
       "      <td>1.157692e-06</td>\n",
       "      <td>800.112631</td>\n",
       "      <td>758.418232</td>\n",
       "      <td>0.521236</td>\n",
       "      <td>...</td>\n",
       "      <td>0.303185</td>\n",
       "      <td>False</td>\n",
       "      <td>6.740607e-07</td>\n",
       "      <td>1.228424e-07</td>\n",
       "      <td>3.937004</td>\n",
       "      <td>True</td>\n",
       "      <td>1.157692e-06</td>\n",
       "      <td>-0.947556</td>\n",
       "      <td>-0.027105</td>\n",
       "      <td>-0.203928</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>20240601</td>\n",
       "      <td>2024</td>\n",
       "      <td>6</td>\n",
       "      <td>SC01</td>\n",
       "      <td>1110.296310</td>\n",
       "      <td>0.527015</td>\n",
       "      <td>-3.726437e-06</td>\n",
       "      <td>697.219664</td>\n",
       "      <td>869.209535</td>\n",
       "      <td>0.525543</td>\n",
       "      <td>...</td>\n",
       "      <td>0.272240</td>\n",
       "      <td>False</td>\n",
       "      <td>1.786760e-06</td>\n",
       "      <td>1.423501e-06</td>\n",
       "      <td>-3.872983</td>\n",
       "      <td>True</td>\n",
       "      <td>-3.726437e-06</td>\n",
       "      <td>3.902506</td>\n",
       "      <td>0.014018</td>\n",
       "      <td>-1.787241</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>20240701</td>\n",
       "      <td>2024</td>\n",
       "      <td>7</td>\n",
       "      <td>SC01</td>\n",
       "      <td>776.203301</td>\n",
       "      <td>0.529498</td>\n",
       "      <td>1.064501e-06</td>\n",
       "      <td>1110.296310</td>\n",
       "      <td>861.239758</td>\n",
       "      <td>0.527015</td>\n",
       "      <td>...</td>\n",
       "      <td>0.272129</td>\n",
       "      <td>False</td>\n",
       "      <td>2.464093e-06</td>\n",
       "      <td>3.554968e-07</td>\n",
       "      <td>-3.937004</td>\n",
       "      <td>True</td>\n",
       "      <td>1.064501e-06</td>\n",
       "      <td>-0.020185</td>\n",
       "      <td>0.083370</td>\n",
       "      <td>-0.234138</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>20240801</td>\n",
       "      <td>2024</td>\n",
       "      <td>8</td>\n",
       "      <td>SC01</td>\n",
       "      <td>779.641505</td>\n",
       "      <td>0.525683</td>\n",
       "      <td>3.609905e-06</td>\n",
       "      <td>776.203301</td>\n",
       "      <td>888.713705</td>\n",
       "      <td>0.529498</td>\n",
       "      <td>...</td>\n",
       "      <td>0.171908</td>\n",
       "      <td>False</td>\n",
       "      <td>-3.553877e-06</td>\n",
       "      <td>1.819602e-06</td>\n",
       "      <td>3.937004</td>\n",
       "      <td>True</td>\n",
       "      <td>3.609905e-06</td>\n",
       "      <td>0.020185</td>\n",
       "      <td>-0.023191</td>\n",
       "      <td>0.591018</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>20240901</td>\n",
       "      <td>2024</td>\n",
       "      <td>9</td>\n",
       "      <td>SC01</td>\n",
       "      <td>714.943279</td>\n",
       "      <td>0.528910</td>\n",
       "      <td>3.020568e-06</td>\n",
       "      <td>779.641505</td>\n",
       "      <td>756.929361</td>\n",
       "      <td>0.525683</td>\n",
       "      <td>...</td>\n",
       "      <td>0.309565</td>\n",
       "      <td>False</td>\n",
       "      <td>3.758813e-06</td>\n",
       "      <td>1.906141e-07</td>\n",
       "      <td>-3.872983</td>\n",
       "      <td>True</td>\n",
       "      <td>3.020568e-06</td>\n",
       "      <td>-0.739458</td>\n",
       "      <td>0.066962</td>\n",
       "      <td>0.399970</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>20241001</td>\n",
       "      <td>2024</td>\n",
       "      <td>10</td>\n",
       "      <td>SC01</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>-4.013804e-06</td>\n",
       "      <td>714.943279</td>\n",
       "      <td>757.502395</td>\n",
       "      <td>0.528910</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>False</td>\n",
       "      <td>-1.033229e-06</td>\n",
       "      <td>4.215169e-06</td>\n",
       "      <td>-0.707107</td>\n",
       "      <td>False</td>\n",
       "      <td>-4.013804e-06</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>-1.880398</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>10 rows √ó 29 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "   date_key     y   m site_code  cost_per_unit_imp  kwh_per_unit_imp  \\\n",
       "0  20240101  2024   1      SC01         777.922403          0.526513   \n",
       "1  20240201  2024   2      SC01         777.922403          0.526513   \n",
       "2  20240301  2024   3      SC01         777.922403          0.526513   \n",
       "3  20240401  2024   4      SC01         800.112631          0.521236   \n",
       "4  20240501  2024   5      SC01         697.219664          0.525543   \n",
       "5  20240601  2024   6      SC01        1110.296310          0.527015   \n",
       "6  20240701  2024   7      SC01         776.203301          0.529498   \n",
       "7  20240801  2024   8      SC01         779.641505          0.525683   \n",
       "8  20240901  2024   9      SC01         714.943279          0.528910   \n",
       "9  20241001  2024  10      SC01         777.922403          0.526513   \n",
       "\n",
       "   fx_effect_ratio_imp  cost_per_unit_imp_lag1  cost_per_unit_imp_roll3  \\\n",
       "0        -3.708762e-08                     NaN                      NaN   \n",
       "1         1.029906e-07              777.922403               777.922403   \n",
       "2        -5.269614e-06              777.922403               777.922403   \n",
       "3         8.005353e-06              777.922403               785.319145   \n",
       "4         1.157692e-06              800.112631               758.418232   \n",
       "5        -3.726437e-06              697.219664               869.209535   \n",
       "6         1.064501e-06             1110.296310               861.239758   \n",
       "7         3.609905e-06              776.203301               888.713705   \n",
       "8         3.020568e-06              779.641505               756.929361   \n",
       "9        -4.013804e-06              714.943279               757.502395   \n",
       "\n",
       "   kwh_per_unit_imp_lag1  ...  kwh_per_unit_imp_z  \\\n",
       "0                    NaN  ...                 NaN   \n",
       "1               0.526513  ...                 NaN   \n",
       "2               0.526513  ...                 NaN   \n",
       "3               0.526513  ...            0.162570   \n",
       "4               0.521236  ...            0.303185   \n",
       "5               0.525543  ...            0.272240   \n",
       "6               0.527015  ...            0.272129   \n",
       "7               0.529498  ...            0.171908   \n",
       "8               0.525683  ...            0.309565   \n",
       "9               0.528910  ...                 NaN   \n",
       "\n",
       "   kwh_per_unit_imp_is_outlier  fx_effect_ratio_imp_mean  \\\n",
       "0                        False              2.718013e-06   \n",
       "1                        False             -1.263414e-06   \n",
       "2                        False             -4.214648e-06   \n",
       "3                        False              7.040908e-06   \n",
       "4                        False              6.740607e-07   \n",
       "5                        False              1.786760e-06   \n",
       "6                        False              2.464093e-06   \n",
       "7                        False             -3.553877e-06   \n",
       "8                        False              3.758813e-06   \n",
       "9                        False             -1.033229e-06   \n",
       "\n",
       "   fx_effect_ratio_imp_std  fx_effect_ratio_imp_z  \\\n",
       "0             3.896301e-06              -0.707107   \n",
       "1             1.932388e-06               0.707107   \n",
       "2             1.491947e-06              -0.707107   \n",
       "3             2.490187e-07               3.872983   \n",
       "4             1.228424e-07               3.937004   \n",
       "5             1.423501e-06              -3.872983   \n",
       "6             3.554968e-07              -3.937004   \n",
       "7             1.819602e-06               3.937004   \n",
       "8             1.906141e-07              -3.872983   \n",
       "9             4.215169e-06              -0.707107   \n",
       "\n",
       "   fx_effect_ratio_imp_is_outlier  fx_effect_ratio_imp_cap  \\\n",
       "0                           False            -3.708762e-08   \n",
       "1                           False             1.029906e-07   \n",
       "2                           False            -5.269614e-06   \n",
       "3                            True             7.040908e-06   \n",
       "4                            True             1.157692e-06   \n",
       "5                            True            -3.726437e-06   \n",
       "6                            True             1.064501e-06   \n",
       "7                            True             3.609905e-06   \n",
       "8                            True             3.020568e-06   \n",
       "9                           False            -4.013804e-06   \n",
       "\n",
       "   cost_per_unit_imp_robust  kwh_per_unit_imp_robust  \\\n",
       "0                  0.000000                 0.000000   \n",
       "1                  0.000000                 0.000000   \n",
       "2                  0.000000                 0.000000   \n",
       "3                  0.260542                -0.147398   \n",
       "4                 -0.947556                -0.027105   \n",
       "5                  3.902506                 0.014018   \n",
       "6                 -0.020185                 0.083370   \n",
       "7                  0.020185                -0.023191   \n",
       "8                 -0.739458                 0.066962   \n",
       "9                  0.000000                 0.000000   \n",
       "\n",
       "   fx_effect_ratio_imp_robust  \n",
       "0                   -0.591246  \n",
       "1                   -0.545836  \n",
       "2                   -2.287501  \n",
       "3                    2.015913  \n",
       "4                   -0.203928  \n",
       "5                   -1.787241  \n",
       "6                   -0.234138  \n",
       "7                    0.591018  \n",
       "8                    0.399970  \n",
       "9                   -1.880398  \n",
       "\n",
       "[10 rows x 29 columns]"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# Ajuste aqui o nome do arquivo gold consolidado\n",
    "# Ex.: 'master_gold.parquet' ou 'gold_consolidado.csv'\n",
    "GOLD_FILENAME = 'kpi_consolidated_outliers_treated.parquet'  # TODO: ajuste se necess√°rio\n",
    "\n",
    "gold_path = DATA_GOLD / GOLD_FILENAME\n",
    "if not gold_path.exists():\n",
    "    # Fallback: tenta csv com nome similar\n",
    "    alt = DATA_GOLD / GOLD_FILENAME.replace('.parquet', '.csv')\n",
    "    if alt.exists():\n",
    "        gold_path = alt\n",
    "\n",
    "print('Carregando:', gold_path)\n",
    "\n",
    "if gold_path.suffix.lower() == '.parquet':\n",
    "    df = pd.read_parquet(gold_path)\n",
    "elif gold_path.suffix.lower() == '.csv':\n",
    "    df = pd.read_csv(gold_path)\n",
    "else:\n",
    "    raise FileNotFoundError(f'Arquivo n√£o encontrado: {gold_path}')\n",
    "\n",
    "print('shape:', df.shape)\n",
    "display(df.head(10))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "9a003f03-44aa-41ba-bf65-07a3bfe3fa70",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Convertido: kpi_consolidated_outliers_treated.parquet ‚Üí kpi_consolidated_outliers_treated.csv\n"
     ]
    }
   ],
   "source": [
    "# Converte cada parquet para CSV\n",
    "parquet_files = gold_path\n",
    "\n",
    "csv_path = parquet_files.with_suffix(\".csv\")\n",
    "df = pd.read_parquet(parquet_files)\n",
    "df.to_csv(csv_path, index=False)\n",
    "print(f\"Convertido: {parquet_files.name} ‚Üí {csv_path.name}\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "084486b6-28ed-4e4f-a559-fd099c11fe03",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Garante nomes de colunas √∫nicos\n",
    "df = df.loc[:, ~df.columns.duplicated()].copy()\n",
    "\n",
    "# Se 'm' e/ou 'site_code' devem ser categ√≥ricas, force dtype categ√≥rico\n",
    "if 'm' in df.columns and not pd.api.types.is_categorical_dtype(df['m']):\n",
    "    df['m'] = df['m'].astype('category')\n",
    "    \n",
    "if 'site_code' in df.columns and not pd.api.types.is_categorical_dtype(df['site_code']):\n",
    "    df['site_code'] = df['site_code'].astype('category')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "8ef964c2-5d12-4837-b656-ce5bc409a553",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Recalcula listas de colunas por dtype\n",
    "numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()\n",
    "categorical_cols = df.select_dtypes(include=['object', 'category']).columns.tolist()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "aef2666a-2034-40bd-8e75-93a6871f8551",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Overlap removido: set()\n"
     ]
    }
   ],
   "source": [
    "# Remove qualquer sobreposi√ß√£o entre num√©ricas e categ√≥ricas\n",
    "overlap = set(numeric_cols).intersection(categorical_cols)\n",
    "if overlap:\n",
    "    # por padr√£o, se estiver em categ√≥rica, tira da num√©rica\n",
    "    numeric_cols = [c for c in numeric_cols if c not in overlap]\n",
    "# (opcional) valide:\n",
    "print('Overlap removido:', overlap)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "f335d4ae-2885-4b94-a411-eef166e9d0d9",
   "metadata": {},
   "outputs": [],
   "source": [
    "#pd.set_option('display.max_columns', None)\n",
    "#df"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3e2011cc-87d6-4bcf-aaee-2f5159a27cb4",
   "metadata": {},
   "source": [
    "### Drop da primeira linha com NaN."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "bd1ddda2-ca45-4467-873b-24180c529bcb",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "(600, 29)\n"
     ]
    }
   ],
   "source": [
    "df = df.dropna(subset=[\n",
    "    'cost_per_unit_imp_lag1',\n",
    "    'cost_per_unit_imp_roll3',\n",
    "    'kwh_per_unit_imp_lag1',\n",
    "    'kwh_per_unit_imp_roll3',\n",
    "    'fx_effect_ratio_imp_lag1',\n",
    "    'fx_effect_ratio_imp_roll3',\n",
    "]).reset_index(drop=True)\n",
    "\n",
    "print(df.shape)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "9d10f936-2fe4-410a-bd36-e8f088bc2482",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>date_key</th>\n",
       "      <th>y</th>\n",
       "      <th>m</th>\n",
       "      <th>site_code</th>\n",
       "      <th>cost_per_unit_imp</th>\n",
       "      <th>kwh_per_unit_imp</th>\n",
       "      <th>fx_effect_ratio_imp</th>\n",
       "      <th>cost_per_unit_imp_lag1</th>\n",
       "      <th>cost_per_unit_imp_roll3</th>\n",
       "      <th>kwh_per_unit_imp_lag1</th>\n",
       "      <th>...</th>\n",
       "      <th>kwh_per_unit_imp_z</th>\n",
       "      <th>kwh_per_unit_imp_is_outlier</th>\n",
       "      <th>fx_effect_ratio_imp_mean</th>\n",
       "      <th>fx_effect_ratio_imp_std</th>\n",
       "      <th>fx_effect_ratio_imp_z</th>\n",
       "      <th>fx_effect_ratio_imp_is_outlier</th>\n",
       "      <th>fx_effect_ratio_imp_cap</th>\n",
       "      <th>cost_per_unit_imp_robust</th>\n",
       "      <th>kwh_per_unit_imp_robust</th>\n",
       "      <th>fx_effect_ratio_imp_robust</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>20240201</td>\n",
       "      <td>2024</td>\n",
       "      <td>2</td>\n",
       "      <td>SC01</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>1.029906e-07</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>False</td>\n",
       "      <td>-1.263414e-06</td>\n",
       "      <td>1.932388e-06</td>\n",
       "      <td>0.707107</td>\n",
       "      <td>False</td>\n",
       "      <td>1.029906e-07</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>-0.545836</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>20240301</td>\n",
       "      <td>2024</td>\n",
       "      <td>3</td>\n",
       "      <td>SC01</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>-5.269614e-06</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>False</td>\n",
       "      <td>-4.214648e-06</td>\n",
       "      <td>1.491947e-06</td>\n",
       "      <td>-0.707107</td>\n",
       "      <td>False</td>\n",
       "      <td>-5.269614e-06</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>-2.287501</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>20240401</td>\n",
       "      <td>2024</td>\n",
       "      <td>4</td>\n",
       "      <td>SC01</td>\n",
       "      <td>800.112631</td>\n",
       "      <td>0.521236</td>\n",
       "      <td>8.005353e-06</td>\n",
       "      <td>777.922403</td>\n",
       "      <td>785.319145</td>\n",
       "      <td>0.526513</td>\n",
       "      <td>...</td>\n",
       "      <td>0.162570</td>\n",
       "      <td>False</td>\n",
       "      <td>7.040908e-06</td>\n",
       "      <td>2.490187e-07</td>\n",
       "      <td>3.872983</td>\n",
       "      <td>True</td>\n",
       "      <td>7.040908e-06</td>\n",
       "      <td>0.260542</td>\n",
       "      <td>-0.147398</td>\n",
       "      <td>2.015913</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>20240501</td>\n",
       "      <td>2024</td>\n",
       "      <td>5</td>\n",
       "      <td>SC01</td>\n",
       "      <td>697.219664</td>\n",
       "      <td>0.525543</td>\n",
       "      <td>1.157692e-06</td>\n",
       "      <td>800.112631</td>\n",
       "      <td>758.418232</td>\n",
       "      <td>0.521236</td>\n",
       "      <td>...</td>\n",
       "      <td>0.303185</td>\n",
       "      <td>False</td>\n",
       "      <td>6.740607e-07</td>\n",
       "      <td>1.228424e-07</td>\n",
       "      <td>3.937004</td>\n",
       "      <td>True</td>\n",
       "      <td>1.157692e-06</td>\n",
       "      <td>-0.947556</td>\n",
       "      <td>-0.027105</td>\n",
       "      <td>-0.203928</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>20240601</td>\n",
       "      <td>2024</td>\n",
       "      <td>6</td>\n",
       "      <td>SC01</td>\n",
       "      <td>1110.296310</td>\n",
       "      <td>0.527015</td>\n",
       "      <td>-3.726437e-06</td>\n",
       "      <td>697.219664</td>\n",
       "      <td>869.209535</td>\n",
       "      <td>0.525543</td>\n",
       "      <td>...</td>\n",
       "      <td>0.272240</td>\n",
       "      <td>False</td>\n",
       "      <td>1.786760e-06</td>\n",
       "      <td>1.423501e-06</td>\n",
       "      <td>-3.872983</td>\n",
       "      <td>True</td>\n",
       "      <td>-3.726437e-06</td>\n",
       "      <td>3.902506</td>\n",
       "      <td>0.014018</td>\n",
       "      <td>-1.787241</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>5 rows √ó 29 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "   date_key     y  m site_code  cost_per_unit_imp  kwh_per_unit_imp  \\\n",
       "0  20240201  2024  2      SC01         777.922403          0.526513   \n",
       "1  20240301  2024  3      SC01         777.922403          0.526513   \n",
       "2  20240401  2024  4      SC01         800.112631          0.521236   \n",
       "3  20240501  2024  5      SC01         697.219664          0.525543   \n",
       "4  20240601  2024  6      SC01        1110.296310          0.527015   \n",
       "\n",
       "   fx_effect_ratio_imp  cost_per_unit_imp_lag1  cost_per_unit_imp_roll3  \\\n",
       "0         1.029906e-07              777.922403               777.922403   \n",
       "1        -5.269614e-06              777.922403               777.922403   \n",
       "2         8.005353e-06              777.922403               785.319145   \n",
       "3         1.157692e-06              800.112631               758.418232   \n",
       "4        -3.726437e-06              697.219664               869.209535   \n",
       "\n",
       "   kwh_per_unit_imp_lag1  ...  kwh_per_unit_imp_z  \\\n",
       "0               0.526513  ...                 NaN   \n",
       "1               0.526513  ...                 NaN   \n",
       "2               0.526513  ...            0.162570   \n",
       "3               0.521236  ...            0.303185   \n",
       "4               0.525543  ...            0.272240   \n",
       "\n",
       "   kwh_per_unit_imp_is_outlier  fx_effect_ratio_imp_mean  \\\n",
       "0                        False             -1.263414e-06   \n",
       "1                        False             -4.214648e-06   \n",
       "2                        False              7.040908e-06   \n",
       "3                        False              6.740607e-07   \n",
       "4                        False              1.786760e-06   \n",
       "\n",
       "   fx_effect_ratio_imp_std  fx_effect_ratio_imp_z  \\\n",
       "0             1.932388e-06               0.707107   \n",
       "1             1.491947e-06              -0.707107   \n",
       "2             2.490187e-07               3.872983   \n",
       "3             1.228424e-07               3.937004   \n",
       "4             1.423501e-06              -3.872983   \n",
       "\n",
       "   fx_effect_ratio_imp_is_outlier  fx_effect_ratio_imp_cap  \\\n",
       "0                           False             1.029906e-07   \n",
       "1                           False            -5.269614e-06   \n",
       "2                            True             7.040908e-06   \n",
       "3                            True             1.157692e-06   \n",
       "4                            True            -3.726437e-06   \n",
       "\n",
       "   cost_per_unit_imp_robust  kwh_per_unit_imp_robust  \\\n",
       "0                  0.000000                 0.000000   \n",
       "1                  0.000000                 0.000000   \n",
       "2                  0.260542                -0.147398   \n",
       "3                 -0.947556                -0.027105   \n",
       "4                  3.902506                 0.014018   \n",
       "\n",
       "   fx_effect_ratio_imp_robust  \n",
       "0                   -0.545836  \n",
       "1                   -2.287501  \n",
       "2                    2.015913  \n",
       "3                   -0.203928  \n",
       "4                   -1.787241  \n",
       "\n",
       "[5 rows x 29 columns]"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "edde2963-bcae-4f2f-8b40-c163b74f4198",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "cost_per_unit_imp             0\n",
      "kwh_per_unit_imp              0\n",
      "fx_effect_ratio_imp           0\n",
      "cost_per_unit_imp_robust      0\n",
      "kwh_per_unit_imp_robust       0\n",
      "fx_effect_ratio_imp_robust    0\n",
      "dtype: int64\n",
      "cost_per_unit_imp_z    600\n",
      "kwh_per_unit_imp_z      33\n",
      "dtype: int64\n"
     ]
    }
   ],
   "source": [
    "# Confer√™ncia r√°pida\n",
    "print(df[['cost_per_unit_imp', \n",
    "          'kwh_per_unit_imp', \n",
    "          'fx_effect_ratio_imp',\n",
    "          'cost_per_unit_imp_robust',\n",
    "          'kwh_per_unit_imp_robust',\t\n",
    "          'fx_effect_ratio_imp_robust']].isna().sum())\n",
    "\n",
    "# Verifica se s√≥ restam NaN nas colunas temporais\n",
    "nulls = df.isna().sum().sort_values(ascending=False)\n",
    "print(nulls[nulls > 0])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cf005776",
   "metadata": {},
   "source": [
    "## 2. Preparos da estrutura temporal e chaves\n",
    "\n",
    "- Garante ordena√ß√£o por data\n",
    "- Conforma o tipo datetime\n",
    "- Seleciona chaves de site e m√™s (se existirem)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "c2fa5e73",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Coluna temporal: date_key | n-null: 600\n",
      "SITE_COL: site_code | MONTH_COL: m\n"
     ]
    }
   ],
   "source": [
    "# Tenta identificar coluna de data automaticamente\n",
    "date_candidates = [c for c in df.columns if 'date' in c.lower() or 'dt' == c.lower()]\n",
    "DATE_COL = None\n",
    "for c in ['date', 'month_start', 'run_ts'] + date_candidates:\n",
    "    if c in df.columns:\n",
    "        DATE_COL = c\n",
    "        break\n",
    "\n",
    "if DATE_COL is None:\n",
    "    print('Nenhuma coluna de data detectada automaticamente. Defina DATE_COL manualmente.')\n",
    "else:\n",
    "    df[DATE_COL] = pd.to_datetime(df[DATE_COL], errors='coerce')\n",
    "    df = df.sort_values(DATE_COL).reset_index(drop=True)\n",
    "    print('Coluna temporal:', DATE_COL, '| n-null:', df[DATE_COL].notna().sum())\n",
    "\n",
    "# Sugest√µes usuais de chaves\n",
    "SITE_COL = 'site_code' if 'site_code' in df.columns else None\n",
    "MONTH_COL = 'm' if 'm' in df.columns else None\n",
    "\n",
    "print('SITE_COL:', SITE_COL, '| MONTH_COL:', MONTH_COL)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "75e56910",
   "metadata": {},
   "source": [
    "## 3. Defini√ß√£o de *targets* e *features*\n",
    "\n",
    "> **Edite esta c√©lula** para definir a(s) vari√°vel(is) alvo(s) e as colunas categ√≥ricas/num√©ricas.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "97e76a32",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "TARGET: cost_per_unit_imp_robust\n",
      "numeric_cols (amostra): ['y', 'cost_per_unit_imp', 'kwh_per_unit_imp', 'fx_effect_ratio_imp', 'cost_per_unit_imp_lag1', 'cost_per_unit_imp_roll3', 'kwh_per_unit_imp_lag1', 'kwh_per_unit_imp_roll3', 'fx_effect_ratio_imp_lag1', 'fx_effect_ratio_imp_roll3'] ... total: 22\n",
      "categorical_cols: ['m', 'site_code']\n"
     ]
    }
   ],
   "source": [
    "#Definindo o(s) alvo(s). \n",
    "# 'cost_per_unit_imp' (custo unit√°rio), 'kwh_per_unit_imp' (energia por unidade), 'fx_effect_ratio_imp', etc.\n",
    "TARGET = 'cost_per_unit_imp_robust'  \n",
    "\n",
    "# Remove alvo e data das features, se presentes\n",
    "for col in [TARGET, DATE_COL]:\n",
    "    if col in numeric_cols: numeric_cols.remove(col)\n",
    "    if col in categorical_cols: \n",
    "        try: categorical_cols.remove(col)\n",
    "        except ValueError: pass\n",
    "\n",
    "# Garante presen√ßa de chaves relevantes\n",
    "if SITE_COL and SITE_COL not in categorical_cols and SITE_COL in df.columns:\n",
    "    categorical_cols.append(SITE_COL)\n",
    "if MONTH_COL and MONTH_COL not in categorical_cols and MONTH_COL in df.columns:\n",
    "    categorical_cols.append(MONTH_COL)\n",
    "\n",
    "print('TARGET:', TARGET)\n",
    "print('numeric_cols (amostra):', numeric_cols[:10], '... total:', len(numeric_cols))\n",
    "print('categorical_cols:', categorical_cols)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8086aa60",
   "metadata": {},
   "source": [
    "## 4. Split de treino e teste preservando temporalidade\n",
    "\n",
    "- Define um **ponto de corte temporal** (ou propor√ß√£o)\n",
    "- Evita *leakage* (treino n√£o \"v√™\" o futuro)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "468ef3e8",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "train: (480, 29) | test: (120, 29)\n"
     ]
    }
   ],
   "source": [
    "# Estrat√©gia: split por propor√ß√£o temporal (fallback)\n",
    "if DATE_COL is not None and df[DATE_COL].notna().any():\n",
    "    split_idx = int(0.8 * len(df))  # 80% inicial para treino\n",
    "    train_df = df.iloc[:split_idx].copy()\n",
    "    test_df = df.iloc[split_idx:].copy()\n",
    "else:\n",
    "    # Se n√£o h√° coluna temporal v√°lida, ainda assim fazemos split simples\n",
    "    split_idx = int(0.8 * len(df))\n",
    "    train_df = df.iloc[:split_idx].copy()\n",
    "    test_df = df.iloc[split_idx:].copy()\n",
    "\n",
    "print('train:', train_df.shape, '| test:', test_df.shape)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4474e581",
   "metadata": {},
   "source": [
    "## 5. *Pipelines* de pr√©-processamento\n",
    "\n",
    "- `OneHotEncoder` para categ√≥ricas\n",
    "- `StandardScaler` para num√©ricas\n",
    "\n",
    "> Tudo encapsulado no `ColumnTransformer`.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "1eebe535",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Preprocess pronto. Exemplo de colunas num√©ricas/categ√≥ricas consideradas:\n",
      "num: ['y', 'cost_per_unit_imp', 'kwh_per_unit_imp', 'fx_effect_ratio_imp', 'cost_per_unit_imp_lag1', 'cost_per_unit_imp_roll3', 'kwh_per_unit_imp_lag1', 'kwh_per_unit_imp_roll3', 'fx_effect_ratio_imp_lag1', 'fx_effect_ratio_imp_roll3'] ...\n",
      "cat: ['m', 'site_code']\n"
     ]
    }
   ],
   "source": [
    "# Definindo X e y\n",
    "X_train = train_df.drop(columns=[TARGET], errors='ignore')\n",
    "y_train = train_df[TARGET].copy()\n",
    "\n",
    "X_test = test_df.drop(columns=[TARGET], errors='ignore')\n",
    "y_test = test_df[TARGET].copy()\n",
    "\n",
    "drop_diag = [c for c in df.columns if c.endswith(('_mean','_std','_z','_is_outlier','_cap'))]\n",
    "X_train = X_train.drop(columns=[c for c in drop_diag if c in X_train.columns])\n",
    "X_test  = X_test.drop(columns=[c for c in drop_diag if c in X_test.columns])\n",
    "\n",
    "num_cols = [col for col in numeric_cols if col in X_train.columns]\n",
    "cat_cols = [col for col in categorical_cols if col in X_train.columns]\n",
    "\n",
    "num_pipe = Pipeline([\n",
    "    ('imp', SimpleImputer(strategy='median')),          # resolve NaN num√©ricos\n",
    "    ('passthrough', RobustScaler(with_centering=False)),         # ou StandardScaler()\n",
    "])\n",
    "\n",
    "cat_pipe = Pipeline([\n",
    "    ('imp', SimpleImputer(strategy='most_frequent')),   # resolve NaN categ√≥ricos\n",
    "    ('ohe', OneHotEncoder(handle_unknown='ignore', drop='first')),\n",
    "])\n",
    "\n",
    "preprocess = ColumnTransformer(\n",
    "    transformers=[\n",
    "        ('num', num_pipe, num_cols),\n",
    "        ('cat', cat_pipe, cat_cols),\n",
    "    ],\n",
    "    remainder='drop'\n",
    ")\n",
    "\n",
    "print('Preprocess pronto. Exemplo de colunas num√©ricas/categ√≥ricas consideradas:')\n",
    "print('num:', [col for col in numeric_cols if col in X_train.columns][:10], '...')\n",
    "print('cat:', [col for col in categorical_cols if col in X_train.columns])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "a8aed08e-816b-435b-b315-9ead572b4a83",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Tem NaN ap√≥s preprocess? False\n"
     ]
    }
   ],
   "source": [
    "Xt = preprocess.fit_transform(X_train)\n",
    "print(\"Tem NaN ap√≥s preprocess?\", np.isnan(Xt).any())  # deve imprimir False"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f9542bb3",
   "metadata": {},
   "source": [
    "## 6. Modelos de Regress√£o ‚Äî *baseline* e regulares\n",
    "\n",
    "- `LinearRegression` (baseline)\n",
    "- `Ridge` / `Lasso`\n",
    "- `RandomForestRegressor`\n",
    "\n",
    "M√©tricas: **MAE**, **RMSE**, **R¬≤** e **MAPE**.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "41e25dc3",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>name</th>\n",
       "      <th>MAE</th>\n",
       "      <th>RMSE</th>\n",
       "      <th>R2</th>\n",
       "      <th>MAPE_%</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>RF</td>\n",
       "      <td>0.210689</td>\n",
       "      <td>0.263617</td>\n",
       "      <td>0.585280</td>\n",
       "      <td>102.575836</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Ridge</td>\n",
       "      <td>0.341288</td>\n",
       "      <td>0.451986</td>\n",
       "      <td>-0.219153</td>\n",
       "      <td>211.894608</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Lasso</td>\n",
       "      <td>0.417345</td>\n",
       "      <td>0.501313</td>\n",
       "      <td>-0.499777</td>\n",
       "      <td>263.087460</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Linear</td>\n",
       "      <td>0.470805</td>\n",
       "      <td>0.526680</td>\n",
       "      <td>-0.655399</td>\n",
       "      <td>316.188301</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "     name       MAE      RMSE        R2      MAPE_%\n",
       "3      RF  0.210689  0.263617  0.585280  102.575836\n",
       "1   Ridge  0.341288  0.451986 -0.219153  211.894608\n",
       "2   Lasso  0.417345  0.501313 -0.499777  263.087460\n",
       "0  Linear  0.470805  0.526680 -0.655399  316.188301"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "def mape(y_true, y_pred, eps=1e-8):\n",
    "    y_true = np.array(y_true)\n",
    "    y_pred = np.array(y_pred)\n",
    "    mask = np.abs(y_true) > eps\n",
    "    return np.mean(np.abs((y_true[mask] - y_pred[mask]) / (y_true[mask] + eps))) * 100.0\n",
    "\n",
    "def evaluate_model(name, model, X_train, y_train, X_test, y_test):\n",
    "    pipe = Pipeline(steps=[('preprocess', preprocess), ('model', model)])\n",
    "    pipe.fit(X_train, y_train)\n",
    "    preds = pipe.predict(X_test)\n",
    "    mae = mean_absolute_error(y_test, preds)\n",
    "    rmse = mean_squared_error(y_test, preds, squared=False)\n",
    "    r2 = r2_score(y_test, preds)\n",
    "    mp = mape(y_test, preds)\n",
    "    #print(f'[{name}]  MAE={mae:,.4f} | RMSE={rmse:,.4f} | R2={r2:,.4f} | MAPE={mp:,.2f}%')\n",
    "    return pipe, {'name': name, 'MAE': mae, 'RMSE': rmse, 'R2': r2, 'MAPE_%': mp}\n",
    "\n",
    "results = []\n",
    "\n",
    "models = [\n",
    "    ('Linear', LinearRegression()),\n",
    "    ('Ridge', Ridge(alpha=1.0)),\n",
    "    ('Lasso', Lasso(alpha=0.001, max_iter=10000)),\n",
    "    ('RF', RandomForestRegressor(n_estimators=300, random_state=42, n_jobs=-1))\n",
    "]\n",
    "\n",
    "fitted = {}\n",
    "for name, model in models:\n",
    "    try:\n",
    "        pipe, res = evaluate_model(name, model, X_train, y_train, X_test, y_test)\n",
    "        fitted[name] = pipe\n",
    "        results.append(res)\n",
    "    except Exception as e:\n",
    "        print(f'Falha em {name}:', e)\n",
    "\n",
    "res_df = pd.DataFrame(results).sort_values('RMSE')\n",
    "display(res_df)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "c53f69a5-3fb0-4df1-9ac8-c7267c21f691",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Best: {'model__max_depth': 10, 'model__max_features': 0.7, 'model__min_samples_leaf': 1, 'model__min_samples_split': 2, 'model__n_estimators': 600} RMSE_cv: 0.27236246716130363\n"
     ]
    }
   ],
   "source": [
    "rf_pipe = Pipeline([('preprocess', preprocess),\n",
    "                    ('model', RandomForestRegressor(random_state=42, n_jobs=-1))])\n",
    "\n",
    "param_grid = {\n",
    "    'model__n_estimators': [300, 600, 900],\n",
    "    'model__max_depth': [None, 6, 10],\n",
    "    'model__min_samples_split': [2, 5, 10],\n",
    "    'model__min_samples_leaf' : [1, 2, 4],\n",
    "    'model__max_features'     : ['sqrt', 'log2', 0.7]\n",
    "}\n",
    "\n",
    "tscv = TimeSeriesSplit(n_splits=5)\n",
    "grid = GridSearchCV(rf_pipe, param_grid, cv=tscv, scoring='neg_root_mean_squared_error', n_jobs=-1)\n",
    "grid.fit(X_train, y_train)\n",
    "print('Best:', grid.best_params_, 'RMSE_cv:', -grid.best_score_)\n",
    "best_rf = grid.best_estimator_"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5054213b-1026-45bc-a208-d7296eab7239",
   "metadata": {},
   "source": [
    "# üìà Interpreta√ß√£o dos Resultados dos Modelos de Regress√£o\n",
    "\n",
    "Os resultados obtidos para os modelos **Linear**, **Lasso**, **Ridge** e **Random Forest** evidenciam diferen√ßas significativas na capacidade de generaliza√ß√£o e na adequa√ß√£o √†s caracter√≠sticas do dataset:\n",
    "\n",
    "| Modelo | MAE | RMSE | R¬≤ | MAPE (%) | Interpreta√ß√£o |\n",
    "|---------|------|------|------|-------------|----------------|\n",
    "| **Random Forest (RF)** | **0.215** | **0.274** | **0.55** | **92.9** | Melhor desempenho geral; capturou rela√ß√µes n√£o lineares entre as vari√°veis |\n",
    "| **Ridge** | 0.472 | 0.601 | -1.15 | 265.9 | Pequena melhora em rela√ß√£o ao linear puro, mas ainda incapaz de ajustar bem a variabilidade |\n",
    "| **Lasso** | 0.613 | 0.742 | -2.28 | 301.5 | Excesso de regulariza√ß√£o; descartou vari√°veis relevantes |\n",
    "| **Linear** | 1.179 | 1.366 | -10.12 | 549.5 | Modelo inadequado; n√£o h√° rela√ß√£o linear dominante |\n",
    "\n",
    "---\n",
    "\n",
    "## üß† Interpreta√ß√£o T√©cnica\n",
    "\n",
    "- O **Random Forest** obteve o melhor ajuste, com R¬≤ positivo (‚âà0.55), indicando que o modelo explica cerca de 55% da varia√ß√£o do custo por unidade (`cost_per_unit_imp_robust`).  \n",
    "  Esse resultado mostra que as rela√ß√µes entre custo, energia e efeito cambial s√£o **n√£o lineares** e envolvem **intera√ß√µes complexas** entre vari√°veis.\n",
    "\n",
    "- Os **modelos lineares** apresentaram R¬≤ negativo, ou seja, tiveram desempenho **pior do que simplesmente prever a m√©dia**.  \n",
    "  Isso confirma que o comportamento das KPIs n√£o segue uma depend√™ncia linear simples.\n",
    "\n",
    "- O **MAPE (%)**, embora alto, reflete a variabilidade natural dos dados imputados e a sensibilidade da m√©trica a valores muito baixos no denominador.\n",
    "\n",
    "---\n",
    "\n",
    "## ‚öôÔ∏è Conclus√µes Pr√°ticas\n",
    "\n",
    "- A **Random Forest** √© o modelo mais adequado para essa base, pois lida naturalmente com **n√£o linearidade**, **outliers** e **intera√ß√µes**.  \n",
    "- Os modelos lineares foram √∫teis como **linha de base explorat√≥ria**, ajudando a confirmar que a rela√ß√£o entre as KPIs √© complexa e n√£o linear.\n",
    "- O pr√≥ximo passo √© realizar **tuning de hiperpar√¢metros** (GridSearch/RandomizedSearch) e an√°lise de **import√¢ncia de vari√°veis** (SHAP ou feature importance) para obter melhor desempenho e interpretabilidade.\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "df23d8d9",
   "metadata": {},
   "source": [
    "## 7. Valida√ß√£o temporal (TimeSeriesSplit)\n",
    "\n",
    "Avalia robustez por cortes sucessivos no tempo.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "65297977",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "TimeSeriesSplit RMSE (neg): [-0.15144865 -0.73021127 -1.27971671 -0.56332019 -0.47461489]\n",
      "RMSE m√©dio: 0.6398623408225272\n"
     ]
    }
   ],
   "source": [
    "if DATE_COL is not None and df[DATE_COL].notna().any():\n",
    "    tscv = TimeSeriesSplit(n_splits=5)\n",
    "    def cv_eval(name, estimator):\n",
    "        pipe_ts = Pipeline(steps=[('preprocess', preprocess), ('model', estimator)])\n",
    "        scores = cross_val_score(pipe_ts, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error', n_jobs=-1)\n",
    "        return {'name': name, 'RMSE_cv': -scores.mean(), 'RMSE_cv': scores.std()} \n",
    "\n",
    "    cv_result = [cv_eval('Linear', LinearRegression()), \n",
    "                 cv_eval('Ridge', Ridge(alpha=1.0)), \n",
    "                 cv_eval('Lasso', Lasso(alpha=0.001, max_iter=10000)),\n",
    "                 cv_eval('RF', RandomForestRegressor(n_estimators=600, \n",
    "                                                     max_depth=10, \n",
    "                                                     min_samples_split=2, \n",
    "                                                     min_samples_leaf=1, \n",
    "                                                     max_features=0.7, \n",
    "                                                     random_state=42, n_jobs=-1, \n",
    "                                                     )\n",
    "                        )]\n",
    "                 \n",
    "    pd.DataFrame(cv_result).sort_values('RMSE_cv')\n",
    "    print('TimeSeriesSplit RMSE (neg):', scores)\n",
    "    print('RMSE m√©dio:', -np.mean(scores))\n",
    "else:\n",
    "    print('Sem coluna temporal v√°lida para TimeSeriesSplit.')"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "409fdfb3",
   "metadata": {},
   "source": [
    "## 8. Explora√ß√£o n√£o supervisionada (KMeans + PCA)\n",
    "\n",
    "Agrupamento de padr√µes e visualiza√ß√£o reduzida com PCA.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "2e9d8c4c",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Falha no KMeans: Input X contains NaN.\n",
      "KMeans does not accept missing values encoded as NaN natively. For supervised learning, you might want to consider sklearn.ensemble.HistGradientBoostingClassifier and Regressor which accept missing values encoded as NaNs natively. Alternatively, it is possible to preprocess the data, for instance by using an imputer transformer in a pipeline or drop samples with missing values. See https://scikit-learn.org/stable/modules/impute.html You can find a list of all estimators that handle NaN values at the following page: https://scikit-learn.org/stable/modules/impute.html#estimators-that-handle-nan-values\n",
      "Falha no PCA/plot: Input X contains NaN.\n",
      "PCA does not accept missing values encoded as NaN natively. For supervised learning, you might want to consider sklearn.ensemble.HistGradientBoostingClassifier and Regressor which accept missing values encoded as NaNs natively. Alternatively, it is possible to preprocess the data, for instance by using an imputer transformer in a pipeline or drop samples with missing values. See https://scikit-learn.org/stable/modules/impute.html You can find a list of all estimators that handle NaN values at the following page: https://scikit-learn.org/stable/modules/impute.html#estimators-that-handle-nan-values\n"
     ]
    }
   ],
   "source": [
    "# Seleciona apenas features utiliz√°veis\n",
    "usable_cols = [c for c in numeric_cols + categorical_cols if c in df.columns]\n",
    "if TARGET in usable_cols:\n",
    "    usable_cols.remove(TARGET)\n",
    "\n",
    "X_all = df[usable_cols].copy()\n",
    "# Pipeline s√≥ de pr√©-processamento\n",
    "X_proc = preprocess.fit_transform(X_all)\n",
    "\n",
    "# Pre-processamento espec√≠fico para a etapa n√£o supervisionada\n",
    "preprocess_unsuper = ColumnTransformer(\n",
    "    transformers=[\n",
    "        ('num', StandardScaler(), [col for col in numeric_cols if col in X_all.columns]),\n",
    "        ('cat', OneHotEncoder(handle_unknown='ignore', drop='first'), [col for col in categorical_cols if col in X_all.columns]),\n",
    "    ],\n",
    "    remainder='drop'\n",
    ")\n",
    "\n",
    "X_proc = preprocess_unsuper.fit_transform(X_all)\n",
    "\n",
    "# KMeans\n",
    "try:\n",
    "    kmeans = KMeans(n_clusters=3, n_init=10, random_state=42)\n",
    "    clusters = kmeans.fit_predict(X_proc)\n",
    "    df['cluster_k3'] = clusters\n",
    "    print('Clusters criados: cluster_k3')\n",
    "except Exception as e:\n",
    "    print('Falha no KMeans:', e)\n",
    "    df['cluster_k3'] = np.nan\n",
    "\n",
    "# PCA para visualiza√ß√£o (2D)\n",
    "try:\n",
    "    pca = PCA(n_components=2, random_state=42)\n",
    "    X_dense = X_proc.toarray() if hasattr(X_proc, 'toarray') else X_proc\n",
    "    X_pca = pca.fit_transform(X_dense)\n",
    "    plt.figure(figsize=(10, 5))\n",
    "    plt.scatter(X_pca[:, 0], X_pca[:, 1], s=12)\n",
    "    plt.title('PCA (2D) dos padr√µes')\n",
    "    plt.xlabel('PC1')\n",
    "    plt.ylabel('PC2')\n",
    "    plt.show()\n",
    "except Exception as e:\n",
    "    print('Falha no PCA/plot:', e)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "48a6c6ec",
   "metadata": {},
   "source": [
    "## 9. *Explainability* (placeholder SHAP / Permutation Importance)\n",
    "\n",
    "> **Opcional:** ative SHAP localmente quando quiser interpretar os modelos de √°rvore.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "id": "802429ce-f276-4c04-9c84-1f92df9dfc47",
   "metadata": {},
   "outputs": [
    {
     "ename": "ValueError",
     "evalue": "All arrays must be of the same length",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mValueError\u001b[0m                                Traceback (most recent call last)",
      "Cell \u001b[0;32mIn[29], line 4\u001b[0m\n\u001b[1;32m      2\u001b[0m imp \u001b[38;5;241m=\u001b[39m permutation_importance(best_rf, X_test, y_test, n_repeats\u001b[38;5;241m=\u001b[39m\u001b[38;5;241m20\u001b[39m, random_state\u001b[38;5;241m=\u001b[39m\u001b[38;5;241m42\u001b[39m, scoring\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mr2\u001b[39m\u001b[38;5;124m'\u001b[39m)\n\u001b[1;32m      3\u001b[0m feat_names \u001b[38;5;241m=\u001b[39m best_rf\u001b[38;5;241m.\u001b[39mnamed_steps[\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mpreprocess\u001b[39m\u001b[38;5;124m'\u001b[39m]\u001b[38;5;241m.\u001b[39mget_feature_names_out()\n\u001b[0;32m----> 4\u001b[0m fi \u001b[38;5;241m=\u001b[39m (\u001b[43mpd\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mDataFrame\u001b[49m\u001b[43m(\u001b[49m\u001b[43m{\u001b[49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[38;5;124;43mfeature\u001b[39;49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[43mfeat_names\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[38;5;124;43mimportance\u001b[39;49m\u001b[38;5;124;43m'\u001b[39;49m\u001b[43m:\u001b[49m\u001b[43m \u001b[49m\u001b[43mimp\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mimportances_mean\u001b[49m\u001b[43m}\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m      5\u001b[0m         \u001b[38;5;241m.\u001b[39msort_values(\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mimportance\u001b[39m\u001b[38;5;124m'\u001b[39m, ascending\u001b[38;5;241m=\u001b[39m\u001b[38;5;28;01mFalse\u001b[39;00m))\n\u001b[1;32m      6\u001b[0m display(fi\u001b[38;5;241m.\u001b[39mhead(\u001b[38;5;241m20\u001b[39m))\n",
      "File \u001b[0;32m~/anaconda3/envs/Regressao/lib/python3.12/site-packages/pandas/core/frame.py:778\u001b[0m, in \u001b[0;36mDataFrame.__init__\u001b[0;34m(self, data, index, columns, dtype, copy)\u001b[0m\n\u001b[1;32m    772\u001b[0m     mgr \u001b[38;5;241m=\u001b[39m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39m_init_mgr(\n\u001b[1;32m    773\u001b[0m         data, axes\u001b[38;5;241m=\u001b[39m{\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mindex\u001b[39m\u001b[38;5;124m\"\u001b[39m: index, \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mcolumns\u001b[39m\u001b[38;5;124m\"\u001b[39m: columns}, dtype\u001b[38;5;241m=\u001b[39mdtype, copy\u001b[38;5;241m=\u001b[39mcopy\n\u001b[1;32m    774\u001b[0m     )\n\u001b[1;32m    776\u001b[0m \u001b[38;5;28;01melif\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(data, \u001b[38;5;28mdict\u001b[39m):\n\u001b[1;32m    777\u001b[0m     \u001b[38;5;66;03m# GH#38939 de facto copy defaults to False only in non-dict cases\u001b[39;00m\n\u001b[0;32m--> 778\u001b[0m     mgr \u001b[38;5;241m=\u001b[39m \u001b[43mdict_to_mgr\u001b[49m\u001b[43m(\u001b[49m\u001b[43mdata\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mindex\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcolumns\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mdtype\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mdtype\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcopy\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mcopy\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mtyp\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mmanager\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    779\u001b[0m \u001b[38;5;28;01melif\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(data, ma\u001b[38;5;241m.\u001b[39mMaskedArray):\n\u001b[1;32m    780\u001b[0m     \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;21;01mnumpy\u001b[39;00m\u001b[38;5;21;01m.\u001b[39;00m\u001b[38;5;21;01mma\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mimport\u001b[39;00m mrecords\n",
      "File \u001b[0;32m~/anaconda3/envs/Regressao/lib/python3.12/site-packages/pandas/core/internals/construction.py:503\u001b[0m, in \u001b[0;36mdict_to_mgr\u001b[0;34m(data, index, columns, dtype, typ, copy)\u001b[0m\n\u001b[1;32m    499\u001b[0m     \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[1;32m    500\u001b[0m         \u001b[38;5;66;03m# dtype check to exclude e.g. range objects, scalars\u001b[39;00m\n\u001b[1;32m    501\u001b[0m         arrays \u001b[38;5;241m=\u001b[39m [x\u001b[38;5;241m.\u001b[39mcopy() \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mhasattr\u001b[39m(x, \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mdtype\u001b[39m\u001b[38;5;124m\"\u001b[39m) \u001b[38;5;28;01melse\u001b[39;00m x \u001b[38;5;28;01mfor\u001b[39;00m x \u001b[38;5;129;01min\u001b[39;00m arrays]\n\u001b[0;32m--> 503\u001b[0m \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43marrays_to_mgr\u001b[49m\u001b[43m(\u001b[49m\u001b[43marrays\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mcolumns\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mindex\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mdtype\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mdtype\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mtyp\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mtyp\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mconsolidate\u001b[49m\u001b[38;5;241;43m=\u001b[39;49m\u001b[43mcopy\u001b[49m\u001b[43m)\u001b[49m\n",
      "File \u001b[0;32m~/anaconda3/envs/Regressao/lib/python3.12/site-packages/pandas/core/internals/construction.py:114\u001b[0m, in \u001b[0;36marrays_to_mgr\u001b[0;34m(arrays, columns, index, dtype, verify_integrity, typ, consolidate)\u001b[0m\n\u001b[1;32m    111\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m verify_integrity:\n\u001b[1;32m    112\u001b[0m     \u001b[38;5;66;03m# figure out the index, if necessary\u001b[39;00m\n\u001b[1;32m    113\u001b[0m     \u001b[38;5;28;01mif\u001b[39;00m index \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[0;32m--> 114\u001b[0m         index \u001b[38;5;241m=\u001b[39m \u001b[43m_extract_index\u001b[49m\u001b[43m(\u001b[49m\u001b[43marrays\u001b[49m\u001b[43m)\u001b[49m\n\u001b[1;32m    115\u001b[0m     \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[1;32m    116\u001b[0m         index \u001b[38;5;241m=\u001b[39m ensure_index(index)\n",
      "File \u001b[0;32m~/anaconda3/envs/Regressao/lib/python3.12/site-packages/pandas/core/internals/construction.py:677\u001b[0m, in \u001b[0;36m_extract_index\u001b[0;34m(data)\u001b[0m\n\u001b[1;32m    675\u001b[0m lengths \u001b[38;5;241m=\u001b[39m \u001b[38;5;28mlist\u001b[39m(\u001b[38;5;28mset\u001b[39m(raw_lengths))\n\u001b[1;32m    676\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mlen\u001b[39m(lengths) \u001b[38;5;241m>\u001b[39m \u001b[38;5;241m1\u001b[39m:\n\u001b[0;32m--> 677\u001b[0m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mAll arrays must be of the same length\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\u001b[1;32m    679\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m have_dicts:\n\u001b[1;32m    680\u001b[0m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\n\u001b[1;32m    681\u001b[0m         \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mMixing dicts with non-Series may lead to ambiguous ordering.\u001b[39m\u001b[38;5;124m\"\u001b[39m\n\u001b[1;32m    682\u001b[0m     )\n",
      "\u001b[0;31mValueError\u001b[0m: All arrays must be of the same length"
     ]
    }
   ],
   "source": [
    "best_rf.fit(X_train, y_train)\n",
    "imp = permutation_importance(best_rf, X_test, y_test, n_repeats=20, random_state=42, scoring='r2')\n",
    "feat_names = best_rf.named_steps['preprocess'].get_feature_names_out()\n",
    "fi = (pd.DataFrame({'feature': feat_names, 'importance': imp.importances_mean})\n",
    "        .sort_values('importance', ascending=False))\n",
    "display(fi.head(20))"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e69407b7",
   "metadata": {},
   "source": [
    "## 10. Persist√™ncia de artefatos\n",
    "\n",
    "- Salva *pipelines* treinados (`joblib`)\n",
    "- Salva bases *train/test* processadas (opcional)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d217b9f7",
   "metadata": {},
   "outputs": [],
   "source": [
    "# %%\n",
    "timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n",
    "\n",
    "# Salva melhor pipeline (por RMSE) se dispon√≠vel\n",
    "if len(results):\n",
    "    top = pd.DataFrame(results).sort_values('RMSE').iloc[0]['name']\n",
    "    best_pipe = fitted[top]\n",
    "    model_path = MODELS_DIR / f'model_{top}_{TARGET}_{timestamp}.joblib'\n",
    "    joblib.dump(best_pipe, model_path)\n",
    "    print('Modelo salvo em:', model_path)\n",
    "\n",
    "# Exporta subconjuntos opcionais\n",
    "train_out = MODEL_INPUT / f'train_{TARGET}_{timestamp}.parquet'\n",
    "test_out  = MODEL_INPUT / f'test_{TARGET}_{timestamp}.parquet'\n",
    "try:\n",
    "    train_df.to_parquet(train_out, index=False)\n",
    "    test_df.to_parquet(test_out, index=False)\n",
    "    print('Train/Test salvos em:', MODEL_INPUT)\n",
    "except Exception as e:\n",
    "    print('Falha ao salvar train/test parquet:', e)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "971b729f-1e1e-4bad-b607-ef8b15f6d353",
   "metadata": {},
   "outputs": [],
   "source": [
    "pipe.named_steps"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d3b60e58-5edb-4c45-95ed-680846590662",
   "metadata": {},
   "outputs": [],
   "source": [
    "pipe.named_steps['model'].get_params()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d12185be",
   "metadata": {},
   "source": [
    "## 11. Pr√≥ximos passos\n",
    "\n",
    "- Ajustar `TARGET` e garantir coer√™ncia de colunas (num√©ricas/categ√≥ricas).\n",
    "- Rodar *grid search* em modelos promissores (Ridge/Lasso/RF/XGB).\n",
    "- Definir *cut-date* de neg√≥cio para splits temporais (ex.: at√© 2025-03 treino, ap√≥s teste).\n",
    "- Criar **relat√≥rio** com m√©tricas e gr√°ficos (colocar em `reports/`).\n",
    "\n",
    "---\n",
    "\n",
    "> Qualquer inconsist√™ncia de colunas (e.g., `date_key`, `month_start_*`) deve ser resolvida na etapa de *feature engineering* anterior. Este notebook assume dados *gold* limpos.\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python Regressao",
   "language": "python",
   "name": "regressao"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.7"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
